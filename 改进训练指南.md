# ğŸš€ æ”¹è¿›è®­ç»ƒæŒ‡å— - æå‡æ¨¡å‹æ€§èƒ½

## ğŸ“Š å½“å‰æƒ…å†µ

æ‚¨çš„å…¨é‡æ¨¡å‹æ€§èƒ½ï¼š
- **RÂ² = 0.373**ï¼ˆåä½ï¼‰
- **æ ·æœ¬æ•°**: 52,031
- **MAE**: 6.16

## âœ¨ å·²å®æ–½çš„æ”¹è¿›

### 1. æ·»åŠ  LightGBM æ”¯æŒ
- âœ… æ›´å¼ºå¤§çš„æ¢¯åº¦æå‡ç®—æ³•
- âœ… æ›´å¿«çš„è®­ç»ƒé€Ÿåº¦
- âœ… æ›´å¥½çš„æ‹Ÿåˆèƒ½åŠ›

### 2. å¢å¼ºè¶…å‚æ•°é…ç½®
- âœ… `n_estimators`: å¯é…ç½®æ ‘çš„æ•°é‡ï¼ˆé»˜è®¤400 â†’ å¯è¾¾800ï¼‰
- âœ… `learning_rate`: å¯é…ç½®å­¦ä¹ ç‡ï¼ˆé»˜è®¤0.05 â†’ å¯è°ƒè‡³0.02-0.05ï¼‰
- âœ… `max_depth`: å¯é…ç½®æ ‘æ·±åº¦ï¼ˆ3 â†’ 5-7ï¼‰

### 3. ç›®æ ‡å˜æ¢
- âœ… `use_log_transform`: log1på˜æ¢å¤„ç†é•¿å°¾åˆ†å¸ƒ

### 4. è¯Šæ–­å·¥å…·
- âœ… `scripts/diagnose_host_performance.py`: åˆ†å®¿ä¸»æ€§èƒ½åˆ†æ

---

## ğŸ¯ æ”¹è¿›è®­ç»ƒæ–¹æ¡ˆï¼ˆæŒ‰æ¨èé¡ºåºï¼‰

### æ–¹æ¡ˆ1ï¸âƒ£: å¹³è¡¡è®­ç»ƒ + LightGBMï¼ˆæ¨èé¦–é€‰ï¼‰â­

**ç”¨æ—¶**: 5-10åˆ†é’Ÿ  
**ç‰¹ç‚¹**: å¹³è¡¡å„å®¿ä¸»ï¼Œä½¿ç”¨LightGBMï¼Œæå‡å®¹é‡

```bash
docker-compose -f docker-compose.microservices.yml run --rm training \
  --input /data/input/training_improved_lgb.json
```

**é¢„æœŸæå‡**: RÂ² å¯èƒ½è¾¾åˆ° 0.5-0.6

---

### æ–¹æ¡ˆ2ï¸âƒ£: å¹³è¡¡è®­ç»ƒ + LightGBM + logå˜æ¢

**ç”¨æ—¶**: 5-10åˆ†é’Ÿ  
**ç‰¹ç‚¹**: é¢å¤–å¤„ç†è¡¨è¾¾å€¼é•¿å°¾åˆ†å¸ƒ

```bash
docker-compose -f docker-compose.microservices.yml run --rm training \
  --input /data/input/training_improved_lgb_log.json
```

**é€‚ç”¨åœºæ™¯**: å¦‚æœè¡¨è¾¾å€¼åˆ†å¸ƒè·¨åº¦å¤§ï¼ˆä¾‹å¦‚0-1000+ï¼‰

---

### æ–¹æ¡ˆ3ï¸âƒ£: ä¸»è¦å®¿ä¸»ä¸“æ³¨è®­ç»ƒ

**ç”¨æ—¶**: 8-15åˆ†é’Ÿ  
**ç‰¹ç‚¹**: åªè®­ç»ƒE_coli/Human/Mouseï¼Œé¿å…å°‘æ ·æœ¬å®¿ä¸»å¹²æ‰°

```bash
docker-compose -f docker-compose.microservices.yml run --rm training \
  --input /data/input/training_improved_main_hosts.json
```

**é¢„æœŸæå‡**: RÂ² å¯èƒ½è¾¾åˆ° 0.55-0.7ï¼ˆé’ˆå¯¹è¿™ä¸‰ä¸ªå®¿ä¸»ï¼‰

---

### æ–¹æ¡ˆ4ï¸âƒ£: å…¨é‡é«˜å®¹é‡è®­ç»ƒï¼ˆæœ€å¼ºæ€§èƒ½ï¼‰

**ç”¨æ—¶**: 20-40åˆ†é’Ÿ  
**ç‰¹ç‚¹**: å…¨éƒ¨52kæ ·æœ¬ï¼Œæœ€é«˜å®¹é‡æ¨¡å‹

```bash
docker-compose -f docker-compose.microservices.yml run --rm training \
  --input /data/input/training_improved_full_lgb.json
```

**é¢„æœŸæå‡**: RÂ² å¯èƒ½è¾¾åˆ° 0.5-0.65

---

## ğŸ“‹ å®Œæ•´æ‰§è¡Œæ­¥éª¤

### ç¬¬1æ­¥: é‡å»ºè®­ç»ƒå®¹å™¨ï¼ˆæ·»åŠ LightGBMï¼‰

```bash
cd /mnt/c/Users/xiayh17/Projects/coursepicker_starter/coursepicker/codon_verifier_ext

# é‡å»ºå®¹å™¨
docker-compose -f docker-compose.microservices.yml build training
```

**ç”¨æ—¶**: 2-5åˆ†é’Ÿï¼ˆé¦–æ¬¡æ„å»ºï¼‰

---

### ç¬¬2æ­¥: è¿è¡Œæ”¹è¿›è®­ç»ƒ

**æ¨è**: å…ˆè¿è¡Œæ–¹æ¡ˆ1ï¼ˆå¹³è¡¡+LightGBMï¼‰

```bash
docker-compose -f docker-compose.microservices.yml run --rm training \
  --input /data/input/training_improved_lgb.json
```

---

### ç¬¬3æ­¥: è¯Šæ–­æ€§èƒ½

è®­ç»ƒå®Œæˆåï¼Œä½¿ç”¨è¯Šæ–­è„šæœ¬åˆ†æå„å®¿ä¸»è¡¨ç°ï¼š

```bash
python3 scripts/diagnose_host_performance.py \
  --model models/improved_lgb_model.pkl \
  --data data/converted/merged_dataset.jsonl \
  --output data/output/diagnosis_improved_lgb.json
```

**è¾“å‡ºç¤ºä¾‹**:
```
E_coli              :  18780 æ ·æœ¬
  RÂ² åˆ†æ•°:       0.6234
  MAE:           4.23
  RMSE:          5.67

Human               :  13346 æ ·æœ¬
  RÂ² åˆ†æ•°:       0.5812
  MAE:           5.45
  RMSE:          7.12
```

---

### ç¬¬4æ­¥: å¯¹æ¯”æ€§èƒ½

```bash
# å¯¹æ¯”æ—§æ¨¡å‹
python3 scripts/diagnose_host_performance.py \
  --model models/full_multihost_model.pkl \
  --data data/converted/merged_dataset.jsonl

# å¯¹æ¯”æ–°æ¨¡å‹
python3 scripts/diagnose_host_performance.py \
  --model models/improved_lgb_model.pkl \
  --data data/converted/merged_dataset.jsonl
```

---

## ğŸ” æ€§èƒ½è¯Šæ–­å·¥å…·

### åˆ†å®¿ä¸»è¯Šæ–­

```bash
python3 scripts/diagnose_host_performance.py \
  --model models/YOUR_MODEL.pkl \
  --data data/converted/merged_dataset.jsonl \
  --output data/output/diagnosis_result.json
```

**è¾“å‡ºä¿¡æ¯**:
- å„å®¿ä¸»çš„ RÂ²ã€MAEã€RMSE
- çœŸå®å€¼ä¸é¢„æµ‹å€¼çš„ç»Ÿè®¡åˆ†å¸ƒ
- Sigmaï¼ˆä¸ç¡®å®šæ€§ï¼‰ä¼°è®¡

---

## ğŸ’¡ é…ç½®å‚æ•°è¯´æ˜

### `surrogate_config` å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | æ¨èèŒƒå›´ | è¯´æ˜ |
|------|--------|----------|------|
| `n_estimators` | 400 | 400-800 | æ ‘çš„æ•°é‡ï¼Œè¶Šå¤šè¶Šå¼ºä½†è®­ç»ƒè¶Šæ…¢ |
| `learning_rate` | 0.05 | 0.02-0.05 | å­¦ä¹ ç‡ï¼Œè¶Šå°è¶Šç¨³å®šä½†éœ€è¦æ›´å¤šæ ‘ |
| `max_depth` | 5 | 5-7 | æ ‘æ·±åº¦ï¼Œè¶Šæ·±è¶Šèƒ½æ‹Ÿåˆå¤æ‚æ¨¡å¼ |
| `use_log_transform` | false | true/false | æ˜¯å¦ä½¿ç”¨log1på˜æ¢ç›®æ ‡å€¼ |
| `quantile_hi` | 0.9 | 0.84-0.95 | ä¸Šåˆ†ä½æ•°ï¼Œç”¨äºä¼°è®¡ä¸ç¡®å®šæ€§ |
| `test_size` | 0.15 | 0.1-0.2 | æµ‹è¯•é›†æ¯”ä¾‹ |

### `data_config` å‚æ•°

| å‚æ•° | è¯´æ˜ |
|------|------|
| `balance_hosts` | `true`: å¹³è¡¡å„å®¿ä¸»æ ·æœ¬æ•° |
| `max_samples_per_host` | æ¯ä¸ªå®¿ä¸»æœ€å¤§æ ·æœ¬æ•° |
| `filter_reviewed_only` | `true`: åªç”¨å®¡æ ¸è¿‡çš„æ¡ç›® |
| `target_hosts` | æŒ‡å®šè®­ç»ƒçš„å®¿ä¸»åˆ—è¡¨ |

---

## ğŸ¨ è‡ªå®šä¹‰é…ç½®ç¤ºä¾‹

å¤åˆ¶å¹¶ä¿®æ”¹é…ç½®ï¼š

```bash
# å¤åˆ¶åŸºç¡€é…ç½®
cp data/input/training_improved_lgb.json data/input/my_custom_training.json

# ç¼–è¾‘é…ç½®
nano data/input/my_custom_training.json
```

**ç¤ºä¾‹ä¿®æ”¹**:
```json
{
  "surrogate_config": {
    "n_estimators": 1000,      // å¢åŠ åˆ°1000æ£µæ ‘
    "learning_rate": 0.02,      // é™ä½å­¦ä¹ ç‡
    "max_depth": 8,             // å¢åŠ æ·±åº¦åˆ°8
    "use_log_transform": true   // å¯ç”¨logå˜æ¢
  }
}
```

---

## ğŸ“Š æœŸæœ›æ€§èƒ½æå‡

æ ¹æ®æ”¹è¿›æªæ–½ï¼Œé¢„æœŸæ€§èƒ½æå‡ï¼š

| æ–¹æ¡ˆ | å½“å‰RÂ² | é¢„æœŸRÂ² | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| åŸå§‹å…¨é‡ | 0.373 | - | åŸºçº¿ |
| æ–¹æ¡ˆ1 (å¹³è¡¡+LGB) | 0.373 | 0.5-0.6 | +35-60% |
| æ–¹æ¡ˆ2 (å¹³è¡¡+LGB+log) | 0.373 | 0.5-0.65 | +35-75% |
| æ–¹æ¡ˆ3 (ä¸»è¦å®¿ä¸») | 0.373 | 0.55-0.7 | +48-88% |
| æ–¹æ¡ˆ4 (å…¨é‡é«˜å®¹é‡) | 0.373 | 0.5-0.65 | +35-75% |

**æ³¨æ„**: å®é™…æå‡å–å†³äºæ•°æ®è´¨é‡å’Œåˆ†å¸ƒ

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1: LightGBMæœªå®‰è£…

**ç—‡çŠ¶**: è®­ç»ƒä»ä½¿ç”¨sklearn GradientBoosting

**è§£å†³**:
```bash
# ç¡®è®¤é‡å»ºäº†å®¹å™¨
docker-compose -f docker-compose.microservices.yml build training

# éªŒè¯LightGBMå¯ç”¨
docker-compose -f docker-compose.microservices.yml run --rm training python3 -c "import lightgbm; print('LightGBM version:', lightgbm.__version__)"
```

### é—®é¢˜2: å†…å­˜ä¸è¶³

**ç—‡çŠ¶**: è®­ç»ƒä¸­æ–­æˆ–ç³»ç»Ÿå¡æ­»

**è§£å†³**: å‡å°‘æ ·æœ¬æ•°
```json
"config": {
  "max_samples_per_host": 2000,  // å‡å°‘åˆ°2000
  "max_samples": 10000            // æ€»æ•°é™åˆ¶10000
}
```

### é—®é¢˜3: è®­ç»ƒæ—¶é—´å¤ªé•¿

**è§£å†³**: å‡å°‘è¶…å‚æ•°
```json
"surrogate_config": {
  "n_estimators": 400,  // å‡å°‘åˆ°400
  "max_depth": 5        // æ·±åº¦é™åˆ°5
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å¦‚æœ RÂ² ä»ç„¶è¾ƒä½ (< 0.5)

1. **æ£€æŸ¥æ•°æ®è´¨é‡**
   ```bash
   # æŸ¥çœ‹è¡¨è¾¾å€¼åˆ†å¸ƒ
   python3 -c "
   import json
   import numpy as np
   values = []
   with open('data/converted/merged_dataset.jsonl') as f:
       for line in f:
           r = json.loads(line)
           expr = r.get('expression', {})
           val = expr.get('value', 0) if isinstance(expr, dict) else expr
           values.append(float(val))
   print(f'æœ€å°å€¼: {np.min(values):.2f}')
   print(f'æœ€å¤§å€¼: {np.max(values):.2f}')
   print(f'å‡å€¼: {np.mean(values):.2f}')
   print(f'ä¸­ä½æ•°: {np.median(values):.2f}')
   print(f'æ ‡å‡†å·®: {np.std(values):.2f}')
   "
   ```

2. **å°è¯•å®¿ä¸»ç‰¹å®šæ¨¡å‹**
   ```bash
   docker-compose -f docker-compose.microservices.yml run --rm training \
     --input /data/input/training_real_host_specific.json
   ```

3. **å¯ç”¨logå˜æ¢** (å¦‚æœè¡¨è¾¾å€¼è·¨åº¦å¤§)

4. **å¢åŠ ç‰¹å¾å·¥ç¨‹** (éœ€è¦ä¿®æ”¹ä»£ç æ·»åŠ æ›´å¤šç‰¹å¾)

---

## âœ… æ¨èæ‰§è¡Œæµç¨‹

```bash
# 1. é‡å»ºå®¹å™¨ï¼ˆä¸€æ¬¡æ€§ï¼‰
docker-compose -f docker-compose.microservices.yml build training

# 2. æ–¹æ¡ˆ1ï¼šå¹³è¡¡è®­ç»ƒ + LightGBM
docker-compose -f docker-compose.microservices.yml run --rm training \
  --input /data/input/training_improved_lgb.json

# 3. è¯Šæ–­æ€§èƒ½
python3 scripts/diagnose_host_performance.py \
  --model models/improved_lgb_model.pkl \
  --data data/converted/merged_dataset.jsonl

# 4. å¦‚æœè¡¨ç°å¥½ï¼Œç»§ç»­å°è¯•logå˜æ¢
docker-compose -f docker-compose.microservices.yml run --rm training \
  --input /data/input/training_improved_lgb_log.json

# 5. å†æ¬¡è¯Šæ–­
python3 scripts/diagnose_host_performance.py \
  --model models/improved_lgb_log_model.pkl \
  --data data/converted/merged_dataset.jsonl

# 6. é€‰æ‹©è¡¨ç°æœ€å¥½çš„æ¨¡å‹ç”¨äºç”Ÿäº§
```

---

## ğŸ‰ é¢„æœŸç»“æœ

å®Œæˆæ”¹è¿›åï¼Œä½ åº”è¯¥å¾—åˆ°ï¼š

âœ… **RÂ² æå‡åˆ° 0.5+**ï¼ˆä»0.373æå‡35%+ï¼‰  
âœ… **MAE é™ä½**ï¼ˆæ›´å‡†ç¡®çš„é¢„æµ‹ï¼‰  
âœ… **å„å®¿ä¸»æ€§èƒ½æŠ¥å‘Š**ï¼ˆçŸ¥é“å“ªäº›å®¿ä¸»è¡¨ç°å¥½ï¼‰  
âœ… **å¤šä¸ªå¯é€‰æ¨¡å‹**ï¼ˆé’ˆå¯¹ä¸åŒåœºæ™¯ï¼‰

---

**ç«‹å³å¼€å§‹æ”¹è¿›ï¼** ğŸš€

```bash
# ä¸€é”®å¼€å§‹
cd /mnt/c/Users/xiayh17/Projects/coursepicker_starter/coursepicker/codon_verifier_ext && \
docker-compose -f docker-compose.microservices.yml build training && \
docker-compose -f docker-compose.microservices.yml run --rm training \
  --input /data/input/training_improved_lgb.json
```

